//////////////////////////////////////////////////////////////////////////////
// tremolo.c - Implementação do Efeito Tremolo
//////////////////////////////////////////////////////////////////////////////

#include "tremolo.h"
#include <math.h>

// Tabela de Seno em Q15 (256 pontos)
#pragma DATA_SECTION(sine_table, ".const")
#pragma DATA_ALIGN(sine_table, 4)
static const Int16 sine_table[SINE_TABLE_SIZE] = {
      0,   804,  1607,  2410,  3211,  4011,  4807,  5601,  6392,  7179,  7961,  8739,  9511, 10278, 11038, 11792,
  12539, 13278, 14009, 14732, 15446, 16150, 16845, 17530, 18204, 18867, 19519, 20159, 20787, 21402, 22004, 22594,
  23169, 23731, 24278, 24811, 25329, 25831, 26318, 26789, 27244, 27683, 28105, 28510, 28897, 29268, 29621, 29955,
  30272, 30571, 30851, 31113, 31356, 31580, 31785, 31970, 32137, 32284, 32412, 32520, 32609, 32678, 32727, 32757,
  32767, 32757, 32727, 32678, 32609, 32520, 32412, 32284, 32137, 31970, 31785, 31580, 31356, 31113, 30851, 30571,
  30272, 29955, 29621, 29268, 28897, 28510, 28105, 27683, 27244, 26789, 26318, 25831, 25329, 24811, 24278, 23731,
  23169, 22594, 22004, 21402, 20787, 20159, 19519, 18867, 18204, 17530, 16845, 16150, 15446, 14732, 14009, 13278,
  12539, 11792, 11038, 10278,  9511,  8739,  7961,  7179,  6392,  5601,  4807,  4011,  3211,  2410,  1607,   804,
      0,  -804, -1607, -2410, -3211, -4011, -4807, -5601, -6392, -7179, -7961, -8739, -9511, -10278, -11038, -11792,
 -12539, -13278, -14009, -14732, -15446, -16150, -16845, -17530, -18204, -18867, -19519, -20159, -20787, -21402, -22004, -22594,
 -23169, -23731, -24278, -24811, -25329, -25831, -26318, -26789, -27244, -27683, -28105, -28510, -28897, -29268, -29621, -29955,
 -30272, -30571, -30851, -31113, -31356, -31580, -31785, -31970, -32137, -32284, -32412, -32520, -32609, -32678, -32727, -32757,
 -32767, -32757, -32727, -32678, -32609, -32520, -32412, -32284, -32137, -31970, -31785, -31580, -31356, -31113, -30851, -30571,
 -30272, -29955, -29621, -29268, -28897, -28510, -28105, -27683, -27244, -26789, -26318, -25831, -25329, -24811, -24278, -23731,
 -23169, -22594, -22004, -21402, -20787, -20159, -19519, -18867, -18204, -17530, -16845, -16150, -15446, -14732, -14009, -13278,
 -12539, -11792, -11038, -10278,  -9511,  -8739,  -7961,  -7179,  -6392,  -5601,  -4807,  -4011,  -3211,  -2410,  -1607,  -804
};

// Variável global do tremolo
Tremolo g_tremolo;

// Inicialização do Tremolo
void initTremolo(void)
{
    Int16 depth = 26214;  // ~0.8 em Q15
    g_tremolo.depth = depth;
    g_tremolo.current_val = 0;
    g_tremolo.phase_acc = 0;
    
    // Cálculo do incremento de fase para 3Hz @ 48kHz
    // Inc = (Freq_Tremolo * 2^32) / Freq_Amostragem
    // Inc = (3 * 4294967296) / 48000 = 268435
    g_tremolo.phase_inc = 268435;
}

// Processamento do Tremolo (otimizado Q15)
void processAudioTremolo(Uint16* rxBlock, Uint16* txBlock, Uint16 blockSize)
{
    int i;
    Int16 xin, yout;
    Int32 temp;
    
    for (i = 0; i < blockSize; i++)
    {
        // Converte entrada para Int16
        xin = (Int16)rxBlock[i];
        
        // Processa tremolo
        Int16 mod = g_tremolo.current_val;
        Int16 half_depth = g_tremolo.depth >> 1;
        Int16 offset = 32767 - half_depth;
        Int16 variable = (Int16)(((Int32)half_depth * mod) >> 15);
        Int16 gain = offset + variable;
        
        // Aplica ganho
        temp = (Int32)xin * gain;
        yout = (Int16)(temp >> 15);
        txBlock[i] = (Uint16)yout;
        
        // Atualiza oscilador para próxima amostra
        g_tremolo.phase_acc += g_tremolo.phase_inc;
        Uint16 index = (Uint16)(g_tremolo.phase_acc >> 24);
        g_tremolo.current_val = sine_table[index];
    }
}